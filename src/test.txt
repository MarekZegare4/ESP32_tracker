#include <Arduino.h>
#include "common/mavlink.h"
#include <Adafruit_GFX.h>
#include <Adafruit_SharpMem.h>

#define mlrsRX  33
#define mlrsTX  32

#define SHARP_SCK  14
#define SHARP_MOSI 13
#define SHARP_SS   12

#define BLACK 0
#define WHITE 1

Adafruit_SharpMem display(SHARP_SCK, SHARP_MOSI, SHARP_SS, 400, 240);

void setup() {
  Serial2.begin(57600, SERIAL_8N1, mlrsRX, mlrsTX);
  Serial.begin(57600);

  display.begin();
  display.clearDisplay();
}

mavlink_status_t status;
mavlink_message_t msg;
int chan = MAVLINK_COMM_0;

void loop() {
  uint16_t available = Serial2.available();
  while (Serial2.available()){
    uint8_t byte = Serial2.read();
    if (mavlink_parse_char(chan, byte, &msg, &status)) {
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(BLACK);
      //display.setCursor(0,0);
      display.println("ID " + String(msg.msgid) + " " + String(msg.seq));
      display.refresh();
      printf("Received message with ID %d, sequence: %d from component %d of system %d\n", msg.msgid, msg.seq, msg.compid, msg.sysid);
      if (display.getCursorY() >= display.height()){
        display.setCursor(0,0);
      }
    }
  }
}
